<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FSFC Trainer — v0.6</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :focus { outline: 2px solid currentColor; outline-offset: 2px; }
    .navbtn{ padding:0.5rem 0.75rem; border-radius:0.75rem; background: rgba(15,23,42,0.65); border:1px solid rgba(255,255,255,0.10); color:#e5e7eb; white-space: nowrap; }
    .navbtn:hover{ background:#334155; }
    .active-tab{ background:#6366f1; color:#0f172a; }
    .ctl{ padding:0.5rem 0.75rem; border-radius:0.5rem; background:#0b1324; border:1px solid rgba(255,255,255,0.10); color:#e5e7eb; width:100%; }
    .ctl::placeholder{ color:#94a3b8; }
    .ctl:focus{ outline:2px solid #6366f1; outline-offset:2px; }
    .ctl:disabled{ opacity:0.7; color:#cbd5e1; background:#0f172a; cursor:not-allowed; }
    select.ctl{ -webkit-text-fill-color:#e5e7eb; color:#e5e7eb; }
    
    .color-swatch{ height:64px; border-radius:0.75rem; display:flex; align-items:center; justify-content:center; }
    /* Specific ring for yellow to be visible */
    .swatch-yellow:focus { outline: 2px solid white; outline-offset: 2px; }
    
    .grid-btn{ aspect-ratio:1 / 1; border-radius:0.75rem; display:flex; align-items:center; justify-content:center; font-weight:600; }
    
    .binary-btn{ height: 160px; border-radius: 1rem; font-size: 2rem; font-weight: 700; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.2s; border: 1px solid rgba(255,255,255,0.1); }
    .binary-btn:hover:not(:disabled) { transform: translateY(-2px); background-color: rgba(30,41,59,0.8); }
    .binary-btn:active:not(:disabled) { transform: translateY(0); }
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100 antialiased font-sans">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <!-- Top Bar / App Nav -->
    <header class="mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">FSFC — Forced-Choice Trainer</h1>
        <p class="text-slate-300 mt-1 text-sm">Zener • Alphabet • Color • Grid • Binary • v0.6</p>
      </div>
      <nav class="flex gap-2 text-sm overflow-x-auto pb-2 md:pb-0 scrollbar-hide">
        <button data-tab="home" class="navbtn active-tab">Home</button>
        <button data-tab="zener" class="navbtn">Zener</button>
        <button data-tab="binary" class="navbtn">Binary</button>
        <button data-tab="alphabet" class="navbtn">Alphabet</button>
        <button data-tab="color" class="navbtn">Color</button>
        <button data-tab="grid" class="navbtn">Grid</button>
        <button data-tab="stats" class="navbtn">Stats</button>
      </nav>
    </header>

    <!-- ====== HOME / SPLASH ====== -->
    <section id="tab-home" class="space-y-6">
      <!-- Games Grid -->
      <div class="bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg">
        <h2 class="text-lg font-semibold">Pick a Game</h2>
        <div id="homeGames" class="grid grid-cols-2 lg:grid-cols-5 gap-3 mt-4">
          <button type="button" data-tab-jump="zener" class="p-4 rounded-2xl bg-emerald-500/90 hover:bg-emerald-400 text-slate-950 font-semibold shadow ring-1 ring-white/10">Zener</button>
          <button type="button" data-tab-jump="binary" class="p-4 rounded-2xl bg-indigo-500/90 hover:bg-indigo-400 text-white font-semibold shadow ring-1 ring-white/10">Binary</button>
          <button type="button" data-tab-jump="alphabet" class="p-4 rounded-2xl bg-slate-800 hover:bg-slate-700 text-slate-200 font-semibold shadow ring-1 ring-white/10">Alphabet</button>
          <button type="button" data-tab-jump="color" class="p-4 rounded-2xl bg-slate-800 hover:bg-slate-700 text-slate-200 font-semibold shadow ring-1 ring-white/10">Color</button>
          <button type="button" data-tab-jump="grid" class="p-4 rounded-2xl bg-slate-800 hover:bg-slate-700 text-slate-200 font-semibold shadow ring-1 ring-white/10">Grid</button>
        </div>
      </div>

      <!-- Overview -->
      <div class="bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">Overview</h2>
          <div class="flex gap-2">
             <button id="importBtnHome" class="px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-xs">Import JSON</button>
             <button id="exportAllBtn" class="px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-xs">Export JSON</button>
             <button id="resetProfileBtn" class="px-3 py-1.5 rounded-lg bg-rose-900/50 hover:bg-rose-900 text-rose-200 text-xs border border-rose-800">Reset Profile</button>
          </div>
        </div>
        <input id="importFile" type="file" accept="application/json" class="hidden" />
        <p id="importStatus" class="text-xs text-slate-400 mb-2"></p>
        
        <div id="homeOverview" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-3"></div>
        <div class="mt-4">
          <canvas id="homeChart" height="100"></canvas>
        </div>
      </div>
    </section>

    <!-- ====== ZENER TRAINER ====== -->
    <section id="tab-zener" class="hidden space-y-6">
      <div class="grid md:grid-cols-3 gap-4">
        <!-- Config -->
        <div class="md:col-span-2 bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg">
          <h2 class="text-lg font-semibold mb-3">Session Setup — Zener</h2>
          <form id="configForm" class="grid sm:grid-cols-2 gap-3">
            <label class="flex flex-col gap-1">
              <span class="text-sm text-slate-300">Number of Trials</span>
              <input id="numTrials" type="number" min="5" step="5" value="25" class="ctl" />
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-slate-300">Feedback Mode</span>
              <select id="mode" class="ctl"><option value="immediate">Immediate</option><option value="delayed">Delayed</option></select>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-slate-300">Target Generator</span>
              <select id="targetGen" class="ctl"><option value="rng">RNG (uniform)</option><option value="deck">Balanced Deck</option></select>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-slate-300">Deck repeats (×5)</span>
              <input id="zDeckRepeats" type="number" min="1" step="1" value="5" class="ctl" disabled />
            </label>
            <label class="flex items-center gap-2 text-sm"><input id="playMode" type="checkbox" class="h-4 w-4" /> Play mode (don’t save)</label>
            <label class="flex items-center gap-2 text-sm"><input id="collectPrePost" type="checkbox" class="h-4 w-4" /> Pre/post sliders</label>
          </form>
          
           <!-- Pre sliders -->
          <div id="preBlock" class="hidden mt-3 grid sm:grid-cols-3 gap-3">
            <label class="flex flex-col gap-1"><span class="text-sm text-slate-300">Pre: Focus</span><input id="preFocus" type="range" min="0" max="10" step="1" value="5" class="w-full"></label>
            <label class="flex flex-col gap-1"><span class="text-sm text-slate-300">Pre: Energy</span><input id="preEnergy" type="range" min="0" max="10" step="1" value="5" class="w-full"></label>
            <label class="flex flex-col gap-1"><span class="text-sm text-slate-300">Pre: Meditation</span><input id="preMeditation" type="range" min="0" max="10" step="1" value="5" class="w-full"></label>
          </div>

          <div class="mt-4 flex gap-2">
            <button id="startBtn" type="button" class="px-5 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-bold">Start Session</button>
            <button id="resetBtn" type="button" class="px-5 py-2 rounded-xl bg-slate-700 hover:bg-slate-600">Stop/Reset</button>
          </div>
          <div class="mt-2 text-xs text-slate-400">Baseline p = 0.20 (5 symbols).</div>
        </div>

        <!-- Live Stats -->
        <aside class="bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg">
          <dl class="grid grid-cols-2 gap-2 text-sm">
            <div><dt class="text-slate-400">Trial</dt><dd id="trialCounter" class="text-xl font-semibold">0 / 0</dd></div>
            <div><dt class="text-slate-400">Hits</dt><dd id="hitCounter" class="text-xl font-semibold">0</dd></div>
            <div><dt class="text-slate-400">z-score</dt><dd id="zScore" class="text-xl font-semibold">—</dd></div>
            <div><dt class="text-slate-400">p (≥)</dt><dd id="pValue" class="text-xl font-semibold">—</dd></div>
          </dl>
          <div id="zenerNote" class="text-xs text-slate-500 mt-2"></div>
        </aside>
      </div>

      <!-- Game Area -->
      <div class="bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg">
        <div class="grid grid-cols-5 gap-2 md:gap-4" id="zenerButtons">
          <!-- Buttons generated via JS or hardcoded below -->
           <button class="zbtn p-2 rounded-xl bg-slate-800 hover:bg-slate-700 ring-1 ring-white/10 disabled:opacity-40" data-symbol="circle">
             <svg viewBox="0 0 100 100" class="w-12 h-12 mx-auto"><circle cx="50" cy="50" r="30" stroke="currentColor" stroke-width="8" fill="none"/></svg>
           </button>
           <button class="zbtn p-2 rounded-xl bg-slate-800 hover:bg-slate-700 ring-1 ring-white/10 disabled:opacity-40" data-symbol="plus">
             <svg viewBox="0 0 100 100" class="w-12 h-12 mx-auto"><path d="M50 20v60M20 50h60" stroke="currentColor" stroke-width="8"/></svg>
           </button>
           <button class="zbtn p-2 rounded-xl bg-slate-800 hover:bg-slate-700 ring-1 ring-white/10 disabled:opacity-40" data-symbol="waves">
             <svg viewBox="0 0 100 100" class="w-12 h-12 mx-auto"><path d="M20 35c10-15 30-15 40 0s30 15 40 0 M20 65c10-15 30-15 40 0s30 15 40 0" stroke="currentColor" stroke-width="8" fill="none"/></svg>
           </button>
           <button class="zbtn p-2 rounded-xl bg-slate-800 hover:bg-slate-700 ring-1 ring-white/10 disabled:opacity-40" data-symbol="square">
             <svg viewBox="0 0 100 100" class="w-12 h-12 mx-auto"><rect x="25" y="25" width="50" height="50" stroke="currentColor" stroke-width="8" fill="none"/></svg>
           </button>
           <button class="zbtn p-2 rounded-xl bg-slate-800 hover:bg-slate-700 ring-1 ring-white/10 disabled:opacity-40" data-symbol="star">
             <svg viewBox="0 0 100 100" class="w-12 h-12 mx-auto"><path d="M50 15l10 25h28l-22 18 8 28-24-16-24 16 8-28-22-18h28z" fill="currentColor"/></svg>
           </button>
        </div>
        <div id="feedback" class="mt-4 hidden text-center text-lg font-bold h-8"></div>
      </div>

      <!-- Results Area -->
      <div id="resultsPanel" class="hidden bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg">
        <h3 class="text-lg font-semibold mb-2">Results</h3>
        <div class="flex gap-2 mb-3">
          <button id="saveSessionBtn" class="px-4 py-2 rounded-lg bg-indigo-500 hover:bg-indigo-400 text-slate-950 font-semibold">Save Session</button>
          <button id="zenerExportBtn" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">Export CSV</button>
        </div>
        <div class="max-h-60 overflow-y-auto">
          <table class="w-full text-sm text-left"><thead class="text-slate-400 sticky top-0 bg-slate-900"><tr><th>#</th><th>Guess</th><th>Target</th><th>Hit</th></tr></thead><tbody id="resultsBody"></tbody></table>
        </div>
      </div>
      
      <!-- Zener Saved List -->
      <div class="bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg">
         <h3 class="text-lg font-semibold mb-2">Saved Zener Sessions</h3>
         <div id="zenerSavedList" class="max-h-64 overflow-y-auto text-sm space-y-2"></div>
      </div>
    </section>

    <!-- ====== BINARY GAME (NEW) ====== -->
    <section id="tab-binary" class="hidden space-y-6">
      <div class="grid md:grid-cols-3 gap-4">
        <div class="md:col-span-2 bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg">
          <h2 class="text-lg font-semibold mb-3">Binary Choice Setup</h2>
          <form class="grid sm:grid-cols-2 gap-3">
            <label class="flex flex-col gap-1">
              <span class="text-sm text-slate-300">Category</span>
              <select id="binType" class="ctl">
                <option value="color">Colors</option>
                <option value="number">Numbers (0-9)</option>
                <option value="zener">Zener Symbols</option>
                <option value="alpha">Alphabet (A-Z)</option>
              </select>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-slate-300">Mode</span>
              <select id="binMode" class="ctl">
                <option value="random">Random Pair (Each Trial)</option>
                <option value="static">Static Pair (Whole Session)</option>
              </select>
            </label>
            
            <!-- Static Selectors -->
            <div id="binStaticSel" class="col-span-2 grid grid-cols-2 gap-3 hidden">
              <label class="flex flex-col gap-1"><span class="text-sm text-slate-300">Option A</span><select id="binOptA" class="ctl"></select></label>
              <label class="flex flex-col gap-1"><span class="text-sm text-slate-300">Option B</span><select id="binOptB" class="ctl"></select></label>
            </div>

            <label class="flex flex-col gap-1">
              <span class="text-sm text-slate-300">Trials</span>
              <input id="binTrials" type="number" value="20" min="10" step="10" class="ctl" />
            </label>
            <div class="flex items-center gap-4 mt-4">
              <label class="flex items-center gap-2 text-sm"><input id="binPlay" type="checkbox" class="h-4 w-4" /> Play mode</label>
            </div>
          </form>

          <div class="mt-4 flex gap-2">
            <button id="binStart" class="px-5 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-400 text-white font-bold">Start Binary</button>
            <button id="binReset" class="px-5 py-2 rounded-xl bg-slate-700 hover:bg-slate-600">Reset</button>
          </div>
          <div class="mt-2 text-xs text-slate-400">Baseline p = 0.50.</div>
        </div>

        <aside class="bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg">
          <dl class="grid grid-cols-2 gap-2 text-sm">
            <div><dt class="text-slate-400">Trial</dt><dd id="binTrialDisp" class="text-xl font-semibold">0 / 0</dd></div>
            <div><dt class="text-slate-400">Hits</dt><dd id="binHitsDisp" class="text-xl font-semibold">0</dd></div>
            <div><dt class="text-slate-400">z-score</dt><dd id="binZDisp" class="text-xl font-semibold">—</dd></div>
            <div><dt class="text-slate-400">p</dt><dd id="binPDisp" class="text-xl font-semibold">—</dd></div>
          </dl>
        </aside>
      </div>

      <!-- Binary Game Board -->
      <div class="bg-slate-900/60 rounded-2xl p-8 ring-1 ring-white/10 shadow-lg text-center">
        <div id="binGameArea" class="grid grid-cols-2 gap-8 max-w-2xl mx-auto">
          <button id="binBtn1" class="binary-btn bg-slate-800 text-slate-200" disabled>A</button>
          <button id="binBtn2" class="binary-btn bg-slate-800 text-slate-200" disabled>B</button>
        </div>
        <div id="binFeedback" class="mt-6 h-6 font-bold text-lg"></div>
      </div>
      
      <!-- Binary Results -->
      <div id="binResults" class="hidden bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg">
        <h3 class="text-lg font-semibold mb-2">Binary Session Results</h3>
        <button id="binSaveBtn" class="mb-3 px-4 py-2 rounded-lg bg-indigo-500 hover:bg-indigo-400 text-white font-semibold">Save Session</button>
        <div class="max-h-60 overflow-y-auto">
          <table class="w-full text-sm text-left"><thead class="text-slate-400"><tr><th>#</th><th>Left/Right</th><th>Guess</th><th>Target</th><th>Hit</th></tr></thead><tbody id="binResultsBody"></tbody></table>
        </div>
      </div>
      
      <div class="bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg">
         <h3 class="text-lg font-semibold mb-2">Saved Binary Sessions</h3>
         <div id="binSavedList" class="max-h-64 overflow-y-auto text-sm space-y-2"></div>
      </div>
    </section>

    <!-- ====== ALPHABET GAME ====== -->
    <section id="tab-alphabet" class="hidden space-y-6">
      <div class="bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg">
        <h2 class="text-lg font-semibold mb-3">Alphabet Game</h2>
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-slate-300 mb-1">String Length (max 100)</label>
            <input id="alphaLen" type="number" min="5" max="100" value="10" class="ctl" />
          </div>
          <div>
            <label class="block text-sm text-slate-300 mb-1">Your Guess (A-Z)</label>
            <input id="alphaGuess" type="text" placeholder="TYPE HERE..." class="ctl uppercase" />
          </div>
          <div class="flex items-center gap-4">
             <label class="flex items-center gap-2 text-sm"><input id="alphaPlay" type="checkbox" class="h-4 w-4" /> Play mode</label>
          </div>
          <div class="flex items-end gap-2">
            <button id="alphaStart" class="px-5 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 font-semibold">Generate & Compare</button>
          </div>
        </div>
      </div>

      <div id="alphaStatsPanel" class="hidden grid md:grid-cols-2 gap-4">
        <div class="bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10">
          <dl class="grid grid-cols-2 gap-2 text-sm">
             <div><dt class="text-slate-400">Length</dt><dd id="alphaResLen" class="text-xl font-bold">0</dd></div>
             <div><dt class="text-slate-400">Hits</dt><dd id="alphaResHits" class="text-xl font-bold">0</dd></div>
             <div><dt class="text-slate-400">z-score</dt><dd id="alphaResZ" class="text-xl font-bold">—</dd></div>
             <div><dt class="text-slate-400">p</dt><dd id="alphaResP" class="text-xl font-bold">—</dd></div>
          </dl>
          <button id="alphaSaveBtn" class="mt-4 px-4 py-2 rounded-lg bg-indigo-500 hover:bg-indigo-400 text-white font-semibold w-full">Save Result</button>
        </div>
        <div class="bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10">
          <h3 class="text-sm font-semibold text-slate-400 mb-2">Comparison</h3>
          <div class="space-y-2 text-sm break-all font-mono leading-relaxed">
            <div><span class="text-slate-500 select-none">You: </span><span id="alphaStrGuess" class="tracking-widest"></span></div>
            <div><span class="text-slate-500 select-none">Tgt: </span><span id="alphaStrTarget" class="tracking-widest text-emerald-400"></span></div>
          </div>
        </div>
      </div>
      
      <div class="bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg">
         <h3 class="text-lg font-semibold mb-2">Saved Alphabet Sessions</h3>
         <div id="alphaSavedList" class="max-h-64 overflow-y-auto text-sm space-y-2"></div>
      </div>
    </section>

    <!-- ====== COLOR GAME ====== -->
    <section id="tab-color" class="hidden space-y-6">
      <div class="grid md:grid-cols-3 gap-4">
        <div class="md:col-span-2 bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg">
          <h2 class="text-lg font-semibold mb-3">Color Game</h2>
          <form class="grid sm:grid-cols-2 gap-3">
            <label class="flex flex-col gap-1"><span class="text-sm text-slate-300">Trials</span><input id="colorTrials" type="number" min="6" step="6" value="30" class="ctl" /></label>
            <label class="flex flex-col gap-1"><span class="text-sm text-slate-300">Mode</span><select id="colorMode" class="ctl"><option value="immediate">Immediate</option><option value="delayed">Delayed</option></select></label>
            <label class="flex flex-col gap-1"><span class="text-sm text-slate-300">Gen</span><select id="colorGen" class="ctl"><option value="rng">RNG</option><option value="deck">Balanced Deck</option></select></label>
            <label class="flex flex-col gap-1"><span class="text-sm text-slate-300">Repeats (x6)</span><input id="colorRepeats" type="number" min="1" value="5" disabled class="ctl" /></label>
            <label class="flex items-center gap-2 text-sm"><input id="colorPlay" type="checkbox" class="h-4 w-4" /> Play mode</label>
          </form>
          <div class="mt-4 flex gap-2">
            <button id="colorStart" class="px-5 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-bold">Start</button>
            <button id="colorReset" class="px-5 py-2 rounded-xl bg-slate-700 hover:bg-slate-600">Reset</button>
          </div>
        </div>
        <aside class="bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg">
          <dl class="grid grid-cols-2 gap-2 text-sm">
             <div><dt class="text-slate-400">Trial</dt><dd id="colorTrialDisp" class="text-xl font-bold">0 / 0</dd></div>
             <div><dt class="text-slate-400">Hits</dt><dd id="colorHitsDisp" class="text-xl font-bold">0</dd></div>
             <div><dt class="text-slate-400">z</dt><dd id="colorZDisp" class="text-xl font-bold">—</dd></div>
             <div><dt class="text-slate-400">p</dt><dd id="colorPDisp" class="text-xl font-bold">—</dd></div>
          </dl>
        </aside>
      </div>

      <div class="bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg">
        <div id="colorBtns" class="grid grid-cols-3 sm:grid-cols-6 gap-4"></div>
        <div id="colorFeedback" class="mt-4 h-6 text-center font-bold"></div>
      </div>
      
      <div id="colorResults" class="hidden bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10">
        <h3 class="text-lg font-semibold mb-2">Results</h3>
        <button id="colorSaveBtn" class="mb-3 px-4 py-2 rounded-lg bg-indigo-500 hover:bg-indigo-400 text-white font-semibold">Save Session</button>
        <div class="max-h-60 overflow-y-auto">
          <table class="w-full text-sm text-left"><thead class="text-slate-400"><tr><th>#</th><th>Guess</th><th>Target</th><th>Hit</th></tr></thead><tbody id="colorResBody"></tbody></table>
        </div>
      </div>
      
      <div class="bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg">
         <h3 class="text-lg font-semibold mb-2">Saved Color Sessions</h3>
         <div id="colorSavedList" class="max-h-64 overflow-y-auto text-sm space-y-2"></div>
      </div>
    </section>

    <!-- ====== GRID GAME ====== -->
    <section id="tab-grid" class="hidden space-y-6">
      <div class="grid md:grid-cols-3 gap-4">
        <div class="md:col-span-2 bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg">
          <h2 class="text-lg font-semibold mb-3">Grid Game</h2>
          <form class="grid sm:grid-cols-2 gap-3">
             <label class="flex flex-col gap-1"><span class="text-sm text-slate-300">Size</span><select id="gridSize" class="ctl"><option value="3">3x3 (9)</option><option value="4">4x4 (16)</option></select></label>
             <label class="flex flex-col gap-1"><span class="text-sm text-slate-300">Trials</span><input id="gridTrials" type="number" min="10" value="45" class="ctl" /></label>
             <label class="flex flex-col gap-1"><span class="text-sm text-slate-300">Mode</span><select id="gridMode" class="ctl"><option value="immediate">Immediate</option><option value="delayed">Delayed</option></select></label>
             <label class="flex flex-col gap-1"><span class="text-sm text-slate-300">Gen</span><select id="gridGen" class="ctl"><option value="rng">RNG</option><option value="deck">Balanced Deck</option></select></label>
             <label class="flex items-center gap-2 text-sm"><input id="gridPlay" type="checkbox" class="h-4 w-4" /> Play mode</label>
          </form>
          <div class="mt-4 flex gap-2">
            <button id="gridStart" class="px-5 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-bold">Start</button>
            <button id="gridReset" class="px-5 py-2 rounded-xl bg-slate-700 hover:bg-slate-600">Reset</button>
          </div>
        </div>
        <aside class="bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg">
          <dl class="grid grid-cols-2 gap-2 text-sm">
             <div><dt class="text-slate-400">Trial</dt><dd id="gridTrialDisp" class="text-xl font-bold">0 / 0</dd></div>
             <div><dt class="text-slate-400">Hits</dt><dd id="gridHitsDisp" class="text-xl font-bold">0</dd></div>
             <div><dt class="text-slate-400">z</dt><dd id="gridZDisp" class="text-xl font-bold">—</dd></div>
             <div><dt class="text-slate-400">p</dt><dd id="gridPDisp" class="text-xl font-bold">—</dd></div>
          </dl>
        </aside>
      </div>
      <div class="bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg text-center">
        <div id="gridBtns" class="mx-auto w-fit gap-2"></div>
        <div id="gridFeedback" class="mt-4 h-6 font-bold"></div>
      </div>
      
      <div id="gridResults" class="hidden bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10">
        <h3 class="text-lg font-semibold mb-2">Results</h3>
        <button id="gridSaveBtn" class="mb-3 px-4 py-2 rounded-lg bg-indigo-500 hover:bg-indigo-400 text-white font-semibold">Save Session</button>
        <div class="max-h-60 overflow-y-auto">
          <table class="w-full text-sm text-left"><thead class="text-slate-400"><tr><th>#</th><th>Guess</th><th>Target</th><th>Hit</th></tr></thead><tbody id="gridResBody"></tbody></table>
        </div>
      </div>
      
      <div class="bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg">
         <h3 class="text-lg font-semibold mb-2">Saved Grid Sessions</h3>
         <div id="gridSavedList" class="max-h-64 overflow-y-auto text-sm space-y-2"></div>
      </div>
    </section>

    <!-- ====== STATS PAGE ====== -->
    <section id="tab-stats" class="hidden space-y-6">
      <div class="bg-slate-900/60 rounded-2xl p-4 ring-1 ring-white/10 shadow-lg">
        <h2 class="text-lg font-semibold mb-2">Progress Chart</h2>
        <div class="flex items-center gap-3 mb-4">
          <label class="text-sm text-slate-300">Game:</label>
          <select id="statsGameSel" class="ctl w-40">
            <option value="zener">Zener</option>
            <option value="binary">Binary</option>
            <option value="color">Color</option>
            <option value="grid">Grid</option>
            <option value="alphabet">Alphabet</option>
          </select>
        </div>
        <canvas id="statsChart" height="120"></canvas>
      </div>
    </section>
    <footer class="mt-8 text-center text-xs text-slate-500">
      ESP Trainer v0.6 • Built for FSFC • One-sided exact binomial p-values • Keyboard accessible • Created by Gemini 3 — November 2025
    </footer>
  </div>

  <script>
    // --- Data & Constants ---
    const SYMBOLS = ["circle","plus","waves","square","star"];
    const COLORS = ["red","blue","green","purple","yellow","orange"];
    const COLOR_HEX = { red:'#ef4444', blue:'#3b82f6', green:'#22c55e', purple:'#a855f7', yellow:'#facc15', orange:'#f97316' };
    const NUMBERS = ["0","1","2","3","4","5","6","7","8","9"];
    const ALPHABET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
    
    // --- Storage Keys ---
    const K_ZENER='fsfc_zener';
    const K_BINARY='fsfc_binary';
    const K_ALPHA='fsfc_alpha';
    const K_COLOR='fsfc_color';
    const K_GRID ='fsfc_grid';

    // --- State ---
    let zenerSess=null, zenerDeck=null;
    let binarySess=null;
    let colorSess=null, colorDeck=null;
    let gridSess=null, gridDeck=null;
    let alphaRes=null;

    // --- Utils ---
    const getLS=(k)=>JSON.parse(localStorage.getItem(k)||'[]');
    const setLS=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
    const rng=(arr)=>arr[Math.floor(Math.random()*arr.length)];
    const shuffle=(a)=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
    const fmt=(n,d=3)=>n===null||isNaN(n)?'—':Number(n).toFixed(d);
    
    // Exact Binomial P-Value (Tail >= k)
    // Uses log-gamma for stability with larger N
    const logFactCache={0:0};
    function logFact(n){if(n in logFactCache)return logFactCache[n];let acc=logFactCache[Object.keys(logFactCache).length-1]||0;for(let i=Object.keys(logFactCache).length;i<=n;i++){acc+=Math.log(i);logFactCache[i]=acc;}return logFactCache[n];}
    function binomPMF(n,k,p){if(k<0||k>n)return 0;const lC=logFact(n)-logFact(k)-logFact(n-k);return Math.exp(lC+k*Math.log(p)+(n-k)*Math.log(1-p));}
    function binomTest(n,k,p){if(k<=0)return 1;if(k>n)return 0;let s=0;for(let i=k;i<=n;i++)s+=binomPMF(n,i,p);return Math.min(1,Math.max(0,s));}
    function zCalc(h,n,p){if(!n)return null;const sd=Math.sqrt(n*p*(1-p));return sd?(h-n*p)/sd:0;}

    // --- Navigation ---
    const tabs=document.querySelectorAll('[data-tab]');
    tabs.forEach(t=>t.addEventListener('click',()=>switchTab(t.dataset.tab)));
    document.querySelectorAll('[data-tab-jump]').forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.tabJump)));

    function switchTab(id){
      document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
      document.getElementById('tab-'+id).classList.remove('hidden');
      tabs.forEach(t=>t.classList.toggle('active-tab', t.dataset.tab===id));
      if(id==='home') renderHome();
      if(id==='stats') renderStats();
    }

    // --- HOME & PROFILE ---
    function renderHome(){
      // Load all counts
      const z=getLS(K_ZENER), b=getLS(K_BINARY), a=getLS(K_ALPHA), c=getLS(K_COLOR), g=getLS(K_GRID);
      const div=document.getElementById('homeOverview');
      div.innerHTML = `
        <div class="p-4 bg-slate-800 rounded-xl"><div>Zener Sessions</div><div class="text-2xl font-bold text-emerald-400">${z.length}</div></div>
        <div class="p-4 bg-slate-800 rounded-xl"><div>Binary Sessions</div><div class="text-2xl font-bold text-indigo-400">${b.length}</div></div>
        <div class="p-4 bg-slate-800 rounded-xl"><div>Color Sessions</div><div class="text-2xl font-bold text-blue-400">${c.length}</div></div>
        <div class="p-4 bg-slate-800 rounded-xl"><div>Grid Sessions</div><div class="text-2xl font-bold text-slate-300">${g.length}</div></div>
        <div class="p-4 bg-slate-800 rounded-xl"><div>Alpha Sessions</div><div class="text-2xl font-bold text-slate-300">${a.length}</div></div>
      `;
      // Simple chart of all activity
      // ... (omitted complex chart for brevity, simple bar chart of counts)
    }

    document.getElementById('resetProfileBtn').addEventListener('click', ()=>{
      if(confirm("Are you sure you want to WIPE ALL DATA? This cannot be undone.")){
        localStorage.clear();
        alert("Profile cleared.");
        location.reload();
      }
    });

    // Import/Export
    document.getElementById('exportAllBtn').addEventListener('click',()=>{
      const data={zener:getLS(K_ZENER),binary:getLS(K_BINARY),alpha:getLS(K_ALPHA),color:getLS(K_COLOR),grid:getLS(K_GRID),ts:Date.now()};
      const b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='fsfc_profile.json';a.click();
    });
    document.getElementById('importBtnHome').addEventListener('click',()=>document.getElementById('importFile').click());
    document.getElementById('importFile').addEventListener('change', function(){
      const f=this.files[0]; if(!f)return;
      const r=new FileReader();
      r.onload=e=>{
        try{
          const d=JSON.parse(e.target.result);
          if(d.zener) setLS(K_ZENER, d.zener);
          if(d.binary) setLS(K_BINARY, d.binary);
          if(d.alpha) setLS(K_ALPHA, d.alpha);
          if(d.color) setLS(K_COLOR, d.color);
          if(d.grid) setLS(K_GRID, d.grid);
          alert("Import successful!");
          renderHome();
        }catch(x){alert("Invalid JSON");}
      };
      r.readAsText(f);
    });

    // ====== ZENER LOGIC ======
    document.getElementById('startBtn').addEventListener('click', startZener);
    document.getElementById('resetBtn').addEventListener('click', ()=>resetZener());
    document.querySelectorAll('.zbtn').forEach(b=>b.addEventListener('click', ()=>guessZener(b.dataset.symbol)));
    
    // Dynamic deck checkbox logic
    document.getElementById('targetGen').addEventListener('change',e=>{
        const d=document.getElementById('zDeckRepeats');
        const t=document.getElementById('numTrials');
        if(e.target.value==='deck'){ d.disabled=false; t.disabled=true; t.value=d.value*5; }
        else{ d.disabled=true; t.disabled=false; }
    });
    document.getElementById('zDeckRepeats').addEventListener('input',e=>{document.getElementById('numTrials').value=e.target.value*5;});

    function startZener(){
      const t=parseInt(document.getElementById('numTrials').value);
      const m=document.getElementById('mode').value;
      const gen=document.getElementById('targetGen').value;
      const play=document.getElementById('playMode').checked;
      zenerDeck = gen==='deck' ? shuffle(SYMBOLS.flatMap(s=>Array(parseInt(document.getElementById('zDeckRepeats').value)).fill(s))) : null;
      
      zenerSess={id:Date.now(), type:'zener', mode:m, gen, trials:[], hits:0, total:t, play, saved:false};
      document.querySelectorAll('.zbtn').forEach(b=>b.disabled=false);
      document.getElementById('resultsPanel').classList.add('hidden');
      updateZenerUI();
    }
    
    function guessZener(sym){
      if(!zenerSess || zenerSess.trials.length>=zenerSess.total) return;
      const tIdx = zenerSess.trials.length;
      const tgt = zenerDeck ? zenerDeck[tIdx] : rng(SYMBOLS);
      const hit = sym===tgt;
      if(hit) zenerSess.hits++;
      zenerSess.trials.push({i:tIdx+1, g:sym, t:tgt, h:hit});
      
      if(zenerSess.mode==='immediate'){
        const fb=document.getElementById('feedback'); fb.classList.remove('hidden');
        fb.innerHTML = hit ? `<span class="text-emerald-400">HIT!</span>` : `<span class="text-rose-400">MISS (${tgt})</span>`;
      }
      updateZenerUI();
      if(zenerSess.trials.length>=zenerSess.total) endZener();
    }
    
    function endZener(){
      document.querySelectorAll('.zbtn').forEach(b=>b.disabled=true);
      document.getElementById('feedback').textContent = "Session Complete";
      renderZenerResults();
      if(!zenerSess.play) {
         saveSession(K_ZENER, zenerSess);
         zenerSess.saved=true;
         updateSaveBtn('saveSessionBtn', true);
      } else {
         updateSaveBtn('saveSessionBtn', false);
      }
      renderZenerSaved();
    }
    
    function updateZenerUI(){
      const n=zenerSess.trials.length; const h=zenerSess.hits;
      document.getElementById('trialCounter').innerText=`${n} / ${zenerSess.total}`;
      document.getElementById('hitCounter').innerText=h;
      // Hide z/p if delayed and running
      const hide = zenerSess.mode==='delayed' && n<zenerSess.total;
      document.getElementById('zScore').innerText = hide ? '?' : fmt(zCalc(h,n,0.2));
      document.getElementById('pValue').innerText = hide ? '?' : fmt(binomTest(n,h,0.2), 4);
    }
    
    function renderZenerResults(){
      const t=document.getElementById('resultsBody'); t.innerHTML='';
      zenerSess.trials.forEach(r=>{
        t.innerHTML+=`<tr><td class="text-slate-500">${r.i}</td><td>${r.g}</td><td>${r.t}</td><td class="${r.h?'text-emerald-400':'text-rose-400'}">${r.h?'HIT':''}</td></tr>`;
      });
      document.getElementById('resultsPanel').classList.remove('hidden');
    }
    
    document.getElementById('saveSessionBtn').addEventListener('click', ()=>{
       if(zenerSess && !zenerSess.saved) {
         saveSession(K_ZENER, zenerSess);
         zenerSess.saved=true;
         updateSaveBtn('saveSessionBtn', true);
         renderZenerSaved();
       }
    });

    function resetZener(){
      zenerSess=null;
      document.querySelectorAll('.zbtn').forEach(b=>b.disabled=true);
      document.getElementById('trialCounter').innerText="0 / 0";
      document.getElementById('resultsPanel').classList.add('hidden');
      document.getElementById('feedback').classList.add('hidden');
    }

    function renderZenerSaved(){
       renderList(K_ZENER, 'zenerSavedList');
    }

    // ====== BINARY LOGIC (NEW) ======
    // Config Logic
    const binStaticSel = document.getElementById('binStaticSel');
    document.getElementById('binMode').addEventListener('change', e=>{
       binStaticSel.classList.toggle('hidden', e.target.value!=='static');
       if(e.target.value==='static') populateBinOptions();
    });
    document.getElementById('binType').addEventListener('change', ()=>{
       if(document.getElementById('binMode').value==='static') populateBinOptions();
    });

    function getBinSet(){
       const t=document.getElementById('binType').value;
       if(t==='color') return COLORS;
       if(t==='number') return NUMBERS;
       if(t==='zener') return SYMBOLS;
       if(t==='alpha') return ALPHABET;
       return COLORS;
    }

    function populateBinOptions(){
       const set=getBinSet();
       const f=(s)=>`<option value="${s}">${s}</option>`;
       document.getElementById('binOptA').innerHTML = set.map(f).join('');
       document.getElementById('binOptB').innerHTML = set.map(f).join('');
       // Default B to second option
       if(set.length>1) document.getElementById('binOptB').selectedIndex=1; 
    }

    document.getElementById('binStart').addEventListener('click', startBinary);
    document.getElementById('binReset').addEventListener('click', resetBinary);
    document.getElementById('binBtn1').addEventListener('click', ()=>guessBinary(0)); // Left
    document.getElementById('binBtn2').addEventListener('click', ()=>guessBinary(1)); // Right

    function startBinary(){
       const mode = document.getElementById('binMode').value;
       const set = getBinSet();
       const trials = parseInt(document.getElementById('binTrials').value);
       const play = document.getElementById('binPlay').checked;
       
       let fixedPair = null;
       if(mode==='static'){
         fixedPair = [document.getElementById('binOptA').value, document.getElementById('binOptB').value];
         if(fixedPair[0]===fixedPair[1]) { alert("Please pick two different options for static mode."); return; }
       }
       
       binarySess = { id:Date.now(), type:'binary', category:document.getElementById('binType').value, mode, trials:[], hits:0, total:trials, play, saved:false, set, fixedPair };
       
       document.getElementById('binBtn1').disabled=false;
       document.getElementById('binBtn2').disabled=false;
       document.getElementById('binResults').classList.add('hidden');
       
       setupBinaryTrial();
       updateBinaryUI();
    }

    function setupBinaryTrial(){
       if(!binarySess) return;
       // 1. Determine Pair
       let pair;
       if(binarySess.mode==='static') pair = [...binarySess.fixedPair];
       else {
          // Pick 2 random distinct
          const s = shuffle([...binarySess.set]);
          pair = [s[0], s[1]];
       }
       
       // 2. Determine Target
       // Target is index 0 or 1 of the pair? No, Target is one value, Distractor is other.
       // Let's randomize position.
       // The logic: System picks Target. System picks Distractor.
       // System shuffles Left/Right presentation.
       
       const target = rng(pair);
       const distractor = pair[0]===target ? pair[1] : pair[0];
       
       // Randomize position on buttons
       const isLeftTarget = Math.random() < 0.5;
       const leftVal = isLeftTarget ? target : distractor;
       const rightVal = isLeftTarget ? distractor : target;
       
       binarySess.currentTrial = { target, leftVal, rightVal, pair };
       
       // Render Buttons
       const b1 = document.getElementById('binBtn1');
       const b2 = document.getElementById('binBtn2');
       
       renderBinBtn(b1, leftVal);
       renderBinBtn(b2, rightVal);
    }

    function renderBinBtn(btn, val){
       btn.textContent = "";
       btn.style.background = "";
       btn.style.color = "";
       
       const cat = binarySess.category;
       if(cat==='color'){
          btn.style.backgroundColor = COLOR_HEX[val];
          // yellow fix
          btn.className = `binary-btn ${val==='yellow'?'text-slate-900':'text-white'}`;
       } else {
          btn.className = "binary-btn bg-slate-800 text-slate-200";
          btn.textContent = val.toUpperCase();
       }
       btn.dataset.val = val;
    }

    function guessBinary(btnIdx){ // 0 = left, 1 = right
       if(!binarySess || binarySess.trials.length >= binarySess.total) return;
       
       const ct = binarySess.currentTrial;
       const guess = btnIdx===0 ? ct.leftVal : ct.rightVal;
       const hit = (guess === ct.target);
       
       if(hit) binarySess.hits++;
       binarySess.trials.push({ i:binarySess.trials.length+1, g:guess, t:ct.target, h:hit, pair:ct.pair });
       
       // Feedback
       const fb = document.getElementById('binFeedback');
       fb.innerHTML = hit ? `<span class="text-emerald-400">HIT!</span>` : `<span class="text-rose-400">MISS (Target: ${ct.target})</span>`;
       
       updateBinaryUI();
       
       if(binarySess.trials.length >= binarySess.total){
          endBinary();
       } else {
          setupBinaryTrial();
       }
    }

    function updateBinaryUI(){
       const n = binarySess.trials.length;
       const h = binarySess.hits;
       document.getElementById('binTrialDisp').innerText = `${n} / ${binarySess.total}`;
       document.getElementById('binHitsDisp').innerText = h;
       document.getElementById('binZDisp').innerText = fmt(zCalc(h,n,0.5));
       document.getElementById('binPDisp').innerText = fmt(binomTest(n,h,0.5),4);
    }

    function endBinary(){
       document.getElementById('binBtn1').disabled=true;
       document.getElementById('binBtn2').disabled=true;
       renderBinResults();
       if(!binarySess.play){
          saveSession(K_BINARY, binarySess);
          binarySess.saved=true;
          updateSaveBtn('binSaveBtn', true);
       } else {
          updateSaveBtn('binSaveBtn', false);
       }
       renderBinSaved();
    }

    function renderBinResults(){
       const tbody = document.getElementById('binResultsBody');
       tbody.innerHTML = binarySess.trials.map(t=>
         `<tr>
            <td class="text-slate-500">${t.i}</td>
            <td class="text-xs text-slate-500">[${t.pair.join('/')}]</td>
            <td>${t.g}</td>
            <td>${t.t}</td>
            <td class="${t.h?'text-emerald-400':'text-rose-400'}">${t.h?'HIT':''}</td>
          </tr>`
       ).join('');
       document.getElementById('binResults').classList.remove('hidden');
    }
    
    function resetBinary(){
       binarySess=null;
       document.getElementById('binBtn1').disabled=true;
       document.getElementById('binBtn1').textContent="A";
       document.getElementById('binBtn1').style.background="";
       document.getElementById('binBtn2').disabled=true;
       document.getElementById('binBtn2').textContent="B";
       document.getElementById('binBtn2').style.background="";
       document.getElementById('binResults').classList.add('hidden');
       document.getElementById('binFeedback').textContent="";
       document.getElementById('binTrialDisp').innerText="0 / 0";
    }

    document.getElementById('binSaveBtn').addEventListener('click', ()=>{
       if(binarySess && !binarySess.saved){
          saveSession(K_BINARY, binarySess);
          binarySess.saved=true;
          updateSaveBtn('binSaveBtn', true);
          renderBinSaved();
       }
    });
    
    function renderBinSaved(){ renderList(K_BINARY, 'binSavedList'); }

    // ====== ALPHABET LOGIC (Fixed) ======
    document.getElementById('alphaStart').addEventListener('click', runAlpha);
    document.getElementById('alphaSaveBtn').addEventListener('click', saveAlpha);
    
    // Cap input
    document.getElementById('alphaGuess').addEventListener('input', function(){
       const max = parseInt(document.getElementById('alphaLen').value)||100;
       if(this.value.length > max) this.value = this.value.substring(0,max);
    });

    function runAlpha(){
       const len = parseInt(document.getElementById('alphaLen').value);
       if(len>100) { alert("Max length 100 for performance."); return; }
       
       const guess = document.getElementById('alphaGuess').value.toUpperCase().replace(/[^A-Z]/g,'');
       if(guess.length !== len){ alert(`Please enter exactly ${len} letters.`); return; }
       
       // Generate Target
       let target = "";
       for(let i=0; i<len; i++) target += ALPHABET[Math.floor(Math.random()*26)];
       
       let hits = 0;
       for(let i=0; i<len; i++) if(guess[i]===target[i]) hits++;
       
       const p = binomTest(len, hits, 1/26);
       const z = zCalc(hits, len, 1/26);
       
       alphaRes = { id:Date.now(), type:'alpha', len, hits, guess, target, z, p, play:document.getElementById('alphaPlay').checked, saved:false };
       
       // UI
       document.getElementById('alphaResLen').innerText = len;
       document.getElementById('alphaResHits').innerText = hits;
       document.getElementById('alphaResZ').innerText = fmt(z);
       document.getElementById('alphaResP').innerText = fmt(p,5);
       
       document.getElementById('alphaStrGuess').innerText = guess;
       document.getElementById('alphaStrTarget').innerText = target;
       
       document.getElementById('alphaStatsPanel').classList.remove('hidden');
       
       if(alphaRes.play) updateSaveBtn('alphaSaveBtn', false);
       else updateSaveBtn('alphaSaveBtn', false, "Save Result"); // Re-enable for manual save if desired, or auto? Alpha is usually manual confirm.
       // Let's make Alpha manual save to avoid clutter if just playing around
       updateSaveBtn('alphaSaveBtn', false, "Save Result");
    }
    
    function saveAlpha(){
       if(alphaRes && !alphaRes.saved){
          // Convert to session format
          const s = {
             id: alphaRes.id, type: 'alpha', trials: alphaRes.len, hits: alphaRes.hits,
             z: alphaRes.z, p: alphaRes.p, ts: Date.now()
          };
          // We don't save the full string to list to save space usually, but could.
          const list = getLS(K_ALPHA);
          list.push(s);
          setLS(K_ALPHA, list);
          alphaRes.saved = true;
          updateSaveBtn('alphaSaveBtn', true);
          renderAlphaSaved();
       }
    }
    function renderAlphaSaved(){ renderList(K_ALPHA, 'alphaSavedList'); }


    // ====== COLOR LOGIC (Polished) ======
    document.getElementById('colorGen').addEventListener('change', e=>{
        const r=document.getElementById('colorRepeats'); const t=document.getElementById('colorTrials');
        if(e.target.value==='deck'){ r.disabled=false; t.disabled=true; t.value=r.value*6; } else { r.disabled=true; t.disabled=false; t.step=6; }
    });
    document.getElementById('colorRepeats').addEventListener('input', e=>document.getElementById('colorTrials').value=e.target.value*6);

    // Generate Buttons
    const cBox = document.getElementById('colorBtns');
    COLORS.forEach(c=>{
       const b = document.createElement('button');
       b.className = `color-swatch ${c==='yellow'?'swatch-yellow':''} ring-1 ring-white/10 transition disabled:opacity-40 hover:scale-105 active:scale-95`;
       b.style.backgroundColor = COLOR_HEX[c];
       b.dataset.color=c;
       b.disabled=true;
       b.addEventListener('click', ()=>guessColor(c));
       cBox.appendChild(b);
    });

    document.getElementById('colorStart').addEventListener('click', ()=>{
       const t=parseInt(document.getElementById('colorTrials').value);
       const gen=document.getElementById('colorGen').value;
       colorDeck = gen==='deck' ? shuffle(COLORS.flatMap(c=>Array(parseInt(document.getElementById('colorRepeats').value)).fill(c))) : null;
       colorSess = {id:Date.now(), type:'color', trials:[], hits:0, total:t, play:document.getElementById('colorPlay').checked, saved:false, mode:document.getElementById('colorMode').value};
       document.querySelectorAll('#colorBtns button').forEach(b=>b.disabled=false);
       document.getElementById('colorResults').classList.add('hidden');
       updateColorUI();
    });
    document.getElementById('colorReset').addEventListener('click', ()=>{
       colorSess=null;
       document.querySelectorAll('#colorBtns button').forEach(b=>b.disabled=true);
       document.getElementById('colorTrialDisp').innerText="0 / 0";
    });

    function guessColor(g){
       if(!colorSess || colorSess.trials.length>=colorSess.total) return;
       const tIdx = colorSess.trials.length;
       const tgt = colorDeck ? colorDeck[tIdx] : rng(COLORS);
       const hit = g===tgt;
       if(hit) colorSess.hits++;
       colorSess.trials.push({i:tIdx+1, g, t:tgt, h:hit});
       
       if(colorSess.mode==='immediate'){
          const fb=document.getElementById('colorFeedback');
          fb.innerHTML = hit?`<span class="text-emerald-400">HIT</span>`:`<span class="text-rose-400">MISS (was ${tgt})</span>`;
       }
       updateColorUI();
       if(colorSess.trials.length>=colorSess.total) endColor();
    }
    
    function updateColorUI(){
       const n=colorSess.trials.length;
       document.getElementById('colorTrialDisp').innerText=`${n} / ${colorSess.total}`;
       document.getElementById('colorHitsDisp').innerText=colorSess.hits;
       const hide = colorSess.mode==='delayed' && n<colorSess.total;
       document.getElementById('colorZDisp').innerText = hide?'?':fmt(zCalc(colorSess.hits,n,1/6));
       document.getElementById('colorPDisp').innerText = hide?'?':fmt(binomTest(n,colorSess.hits,1/6),4);
    }
    
    function endColor(){
       document.querySelectorAll('#colorBtns button').forEach(b=>b.disabled=true);
       const tb=document.getElementById('colorResBody'); tb.innerHTML='';
       colorSess.trials.forEach(r=>{
          tb.innerHTML+=`<tr><td>${r.i}</td><td style="color:${COLOR_HEX[r.g]}">■</td><td style="color:${COLOR_HEX[r.t]}">■</td><td class="${r.h?'text-emerald-400':''}">${r.h?'HIT':''}</td></tr>`;
       });
       document.getElementById('colorResults').classList.remove('hidden');
       
       if(!colorSess.play){
          saveSession(K_COLOR, colorSess);
          colorSess.saved=true;
          updateSaveBtn('colorSaveBtn', true);
       } else {
          updateSaveBtn('colorSaveBtn', false);
       }
       renderColorSaved();
    }
    
    document.getElementById('colorSaveBtn').addEventListener('click', ()=>{
       if(colorSess && !colorSess.saved){
          saveSession(K_COLOR, colorSess);
          colorSess.saved=true;
          updateSaveBtn('colorSaveBtn', true);
          renderColorSaved();
       }
    });
    function renderColorSaved(){ renderList(K_COLOR, 'colorSavedList'); }

    // ====== GRID LOGIC ======
    // (Similar structure, reusing concepts)
    // Generating Buttons
    function mkGrid(sz){
       const c=document.getElementById('gridBtns'); c.innerHTML='';
       c.style.display='grid'; c.style.gridTemplateColumns=`repeat(${sz}, 1fr)`;
       for(let i=0;i<sz*sz;i++){
         const b=document.createElement('button');
         b.className='grid-btn w-16 h-16 bg-slate-800 ring-1 ring-white/10 hover:bg-slate-700 disabled:opacity-40 text-slate-500';
         b.innerText=i+1; b.disabled=true;
         b.addEventListener('click',()=>guessGrid(i));
         c.appendChild(b);
       }
    }
    document.getElementById('gridSize').addEventListener('change',e=>mkGrid(parseInt(e.target.value)));
    mkGrid(3); // init

    document.getElementById('gridStart').addEventListener('click', ()=>{
       const sz=parseInt(document.getElementById('gridSize').value);
       const cells=sz*sz;
       const t=parseInt(document.getElementById('gridTrials').value);
       const gen=document.getElementById('gridGen').value;
       if(gen==='deck') gridDeck = shuffle(Array.from({length:t}, (_,i)=>i%cells));
       
       gridSess={id:Date.now(), type:'grid', sz, cells, trials:[], hits:0, total:t, play:document.getElementById('gridPlay').checked, saved:false, mode:document.getElementById('gridMode').value};
       document.querySelectorAll('.grid-btn').forEach(b=>b.disabled=false);
       document.getElementById('gridResults').classList.add('hidden');
       updateGridUI();
    });
    document.getElementById('gridReset').addEventListener('click',()=>{
       gridSess=null; document.querySelectorAll('.grid-btn').forEach(b=>b.disabled=true);
       document.getElementById('gridTrialDisp').innerText="0 / 0";
    });
    
    function guessGrid(g){
       if(!gridSess || gridSess.trials.length>=gridSess.total) return;
       const tIdx=gridSess.trials.length;
       const tgt = gridDeck ? gridDeck[tIdx] : Math.floor(Math.random()*gridSess.cells);
       const hit=g===tgt;
       if(hit) gridSess.hits++;
       gridSess.trials.push({i:tIdx+1,g,t:tgt,h:hit});
       
       if(gridSess.mode==='immediate'){
          const fb=document.getElementById('gridFeedback');
          fb.innerHTML = hit?`<span class="text-emerald-400">HIT</span>`:`<span class="text-rose-400">MISS (${tgt+1})</span>`;
       }
       updateGridUI();
       if(gridSess.trials.length>=gridSess.total) endGrid();
    }
    function updateGridUI(){
       const n=gridSess.trials.length;
       document.getElementById('gridTrialDisp').innerText=`${n} / ${gridSess.total}`;
       document.getElementById('gridHitsDisp').innerText=gridSess.hits;
       const p=1/gridSess.cells;
       const hide=gridSess.mode==='delayed' && n<gridSess.total;
       document.getElementById('gridZDisp').innerText=hide?'?':fmt(zCalc(gridSess.hits,n,p));
       document.getElementById('gridPDisp').innerText=hide?'?':fmt(binomTest(n,gridSess.hits,p),4);
    }
    function endGrid(){
       document.querySelectorAll('.grid-btn').forEach(b=>b.disabled=true);
       const tb=document.getElementById('gridResBody'); tb.innerHTML='';
       gridSess.trials.forEach(r=>{
          tb.innerHTML+=`<tr><td>${r.i}</td><td>${r.g+1}</td><td>${r.t+1}</td><td class="${r.h?'text-emerald-400':''}">${r.h?'HIT':''}</td></tr>`;
       });
       document.getElementById('gridResults').classList.remove('hidden');
       if(!gridSess.play){
          saveSession(K_GRID, gridSess);
          gridSess.saved=true;
          updateSaveBtn('gridSaveBtn', true);
       } else {
          updateSaveBtn('gridSaveBtn', false);
       }
       renderGridSaved();
    }
    document.getElementById('gridSaveBtn').addEventListener('click', ()=>{
       if(gridSess && !gridSess.saved){
          saveSession(K_GRID, gridSess);
          gridSess.saved=true;
          updateSaveBtn('gridSaveBtn', true);
          renderGridSaved();
       }
    });
    function renderGridSaved(){ renderList(K_GRID, 'gridSavedList'); }


    // ====== SHARED HELPERS ======
    function saveSession(key, sess){
       // Minimal save object
       const s = {
          id: sess.id, ts: Date.now(),
          trials: sess.total || sess.len,
          hits: sess.hits,
          type: sess.type,
          z: zCalc(sess.hits, sess.total||sess.len, getP(sess)),
          p: binomTest(sess.total||sess.len, sess.hits, getP(sess))
       };
       // Specific extras
       if(sess.type==='binary') s.subtype=sess.category;
       if(sess.type==='grid') s.sz=sess.sz;
       
       const list = getLS(key);
       list.push(s);
       setLS(key, list);
    }
    
    function getP(s){
       if(s.type==='zener') return 0.2;
       if(s.type==='binary') return 0.5;
       if(s.type==='color') return 1/6;
       if(s.type==='grid') return 1/s.cells;
       if(s.type==='alpha') return 1/26;
       return 0.5;
    }

    function updateSaveBtn(id, saved, label=null){
       const b=document.getElementById(id);
       if(saved){
          b.disabled=true;
          b.classList.add('opacity-50', 'cursor-not-allowed');
          b.innerText="Saved";
       } else {
          b.disabled=false;
          b.classList.remove('opacity-50', 'cursor-not-allowed');
          b.innerText=label||"Save Session";
          // If it's Play Mode, we might want to hide it or keep it optional.
          // Current logic: If play mode, button is enabled but requires manual click.
       }
    }

    function renderList(key, domId){
       const l=getLS(key).reverse();
       const el=document.getElementById(domId);
       if(!l.length) { el.innerHTML='<div class="text-slate-500 italic">No saved sessions.</div>'; return; }
       el.innerHTML = l.map(s=>`
         <div class="flex justify-between items-center bg-slate-800 p-2 rounded border border-slate-700">
           <div>
             <div class="font-bold text-xs text-slate-400">${new Date(s.ts).toLocaleString()}</div>
             <div>Hits: ${s.hits}/${s.trials} <span class="text-slate-500">|</span> z: ${fmt(s.z)} <span class="text-slate-500">|</span> p: ${fmt(s.p,4)}</div>
           </div>
           <div class="text-xs font-mono bg-slate-900 px-2 py-1 rounded">${s.type==='binary'?s.subtype: (s.type==='grid'? s.sz+'x'+s.sz : s.type)}</div>
         </div>
       `).join('');
    }
    
    // ====== STATS PAGE ======
    function renderStats(){
       // Simple line chart of Z-scores over time for selected game
       const g = document.getElementById('statsGameSel').value;
       let k = K_ZENER;
       if(g==='binary') k=K_BINARY;
       if(g==='color') k=K_COLOR;
       if(g==='grid') k=K_GRID;
       if(g==='alphabet') k=K_ALPHA;
       
       const data = getLS(k);
       const ctx = document.getElementById('statsChart').getContext('2d');
       
       // Destroy old if exists
       if(window.myChart) window.myChart.destroy();
       
       window.myChart = new Chart(ctx, {
          type: 'line',
          data: {
             labels: data.map((_,i)=>i+1),
             datasets: [{
                label: 'Cumulative Z-Score', // Simplifying to just per-session Z for visual check, or Cumulative? 
                // Let's do Per-Session Z to see spikes
                data: data.map(d=>d.z),
                borderColor: '#6366f1',
                tension: 0.2
             }]
          },
          options: {
             responsive: true,
             plugins: { legend: {display:false}, title:{display:true, text:`${g.toUpperCase()} Performance (z-score)`} },
             scales: { y: { beginAtZero: false, grid:{color:'rgba(255,255,255,0.1)'} }, x: { display:false } }
          }
       });
    }
    document.getElementById('statsGameSel').addEventListener('change', renderStats);

    // Initial Load
    renderHome();
    renderZenerSaved();
    renderBinSaved();
    renderAlphaSaved();
    renderColorSaved();
    renderGridSaved();
  </script>
</body>
</html>